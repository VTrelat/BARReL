\section{Discussion and Future Work}

We identify three main directions for future work:
\begin{itemize}
	\item extending the supported fragment of the B mathematical language and the accompanying lemma library;
	\item reducing redundancy among generated WD obligations via subsumption;
	\item enriching automation beyond WD goals for recurring proof-obligation patterns.
\end{itemize}

\subsection{Increasing coverage of B}

\barrel currently supports a practically useful fragment of the B mathematical language covering the set/relational core used by typical Atelier~B proof obligations, together with common arithmetic and finiteness idioms as summarized in \cref{tab:fragment}.
Advanced data structuring features and less common operators are currently out of scope, but can be added incrementally.

Extending \barrel's supported fragment typically requires, for each new B symbol:
\begin{itemize}
	\item a Lean definition and notation close to the B syntax,
	\item a parsing and an encoding rule,
	\item a WD predicate and corresponding WD generation rule for partial operators,
	\item a small supporting lemma kit (equational rules, basic facts and WD lemmas) so that the automation layer remains effective.
\end{itemize}
%
\begin{table}[t]
	\caption{Current coverage of \barrel. Bold operators are partial and generate WD side goals.}
	\label{tab:fragment}
	\centering
	\small
	\begin{tabular}{p{0.2\linewidth}p{0.72\linewidth}}
		\textbf{Category} & \textbf{Constructs}                                                                                               \\
		\hline
		Logical operators &
		conjunction, disjunction, negation, implication, equivalence, bounded universal and existential quantification, equality              \\
		\hline
		Set theory        &
		basic sets (\texttt{NATURAL}, \texttt{NATURAL1}, \texttt{NAT}, \texttt{NAT1}, \texttt{BOOL}, \texttt{REAL}, etc.), singleton, cartesian product, union, intersection, set difference, inclusion, powerset,
		bounded comprehension, membership, finite powerset, \textbf{cardinality}                                                              \\
		\hline
		Relations         &
		domain, range, relational image, (co-)restriction, (co-)subtraction, converse, composition, overloading, identity                     \\
		\hline
		Functions         &
		function spaces (partial/total/injective/surjective/bijective as functional relations),
		\textbf{function application}, $\lambda$-abstraction                                                                                  \\
		\hline
		Sequences         &
		set of sequences (\texttt{seq}), \textbf{size}                                                                                        \\
		\hline
		Arithmetic        &
		integers, intervals, usual orderings, basic arithmetic operators (addition, multiplication, etc.), \textbf{minimum}, \textbf{maximum} \\
	\end{tabular}
	\normalsize
\end{table}
%
Table~\ref{tab:fragment} summarizes the current coverage and the partial operators for which \barrel generates WD obligations.
Missing constructs include sequences (beyond size, there are many more operations like concatenation, head, tail, etc.), trees, quantified operators (union, intersection, summation, product), and more advanced operations like permutations, closures, etc.

\paragraph*{Implementation metrics}

Considering core tooling only, \barrel consists of 1{,}331 lines of code (LoC), excluding blank and comment lines and including the embedding of the B syntax, the parser, the encoder, and the discharger/meta-programming layer---witnessing a relatively lightweight implementation.

The artifacts also include the previously mentioned library of auxiliary equational and simplification lemmas: the B ``builtins'' library (\texttt{Barrel/Builtins/*}) accounts for 1{,}282 LoC and contains supporting facts about sets, relations, functions, arithmetic and well-definedness, as well as the mentioned automation tactics.

\begin{table}[htb]
	\caption{Implementation metrics of the artifacts containing \barrel.}
	\label{tab:implementation-metrics}
	\centering
	\begin{tabular}{l r}
		\textbf{Component}    & \textbf{LoC}     \\
		\hline
		Core tooling          & 1{,}331          \\
		Lemmas and automation & 1{,}282          \\
		Examples and tests    & 585              \\
		\hline
		\textbf{Total}        & \textbf{3{,}198} \\
	\end{tabular}
\end{table}

Finally, the artifacts also contain examples from the paper and more that exercise \barrel's workflow.
These metrics are summarized in \cref{tab:implementation-metrics}.

\subsection{Reducing the number of WD side goals via subsumption}\label{subsec:future-wd-subsumption}
One challenge with \barrel is that it generates a lot of WD side goals compared to Atelier B, as evidenced by \cref{tab:case-study-stats}.
This stems from a combination of multiple factors: \begin{itemize}
	\item Atelier B is able to reason directly on the machine itself, while \barrel only knows about the obligations generated.
	      Thus, Atelier B can insert WD conditions only where needed (at the call sites of partial operators, before generating the goals), once and for all, and share them between sub-goals (or rather not duplicate them).
	\item When invariants are $n$-ary conjunctions, Atelier B's PO generator outputs multiple separate obligations (one per conjunct) while duplicating the hypotheses.
	      Since \barrel encodes each obligation individually and separately, WD conditions that come from hypotheses of the obligation (e.g.\@ in invariant preservation goals) are needlessly duplicated.
\end{itemize}
Although most of these WD side goals are automatically discharged by an internal tactic (see \cref{par:automation}), the remaining ones may still require proving the same WD condition in multiple different---but subsumable---contexts.
We leave as future work implementing subsumption of WD conditions to reduce the number of side goals generated, thus improving overall performance of \barrel when importing a B machine.


% In practice, although \barrel generates a lot more WD side goals, most are automatically solved by an internal tactic\todo[Just mention again what's been decribed in \cref{par:automation}] made specifically for discharging WD conditions.
% The remaining WD side goals, those that are not automatically proved, are usually either totally unrelated or logical consequences of each other.
% \todo[blah blah blah implement subsumption and voil√†! (I don't quite know how to say it here)]

\subsection{Automation beyond WD obligations}\label{sec:future-auto}

The current tactic layer of \barrel is intentionally narrow: it targets WD side conditions and leaves the remaining obligations---typically invariant preservation and refinement simulation---to interactive proof.
In practice, these non-WD obligations also exhibit highly regular structures---such as routine set/relational algebra, standard refinement simulation patterns, and repeated use of the same invariants---suggesting that they also admit dedicated, domain-specific automation.
Since \barrel operates entirely inside Lean, such automation is \emph{proof-producing}, meaning that such tactics synthesize proof terms that are checked by the kernel.
The relevant design goal is to increase proof-search power while keeping proofs readable and predictable.

A concrete plan for extending \barrel's automation layer includes:
\begin{itemize}
	\item  enriching the simplification and rewriting library for B-style set and relational algebra (domain/range laws, restriction/subtraction, relational image and composition) so that obligations normalize to ``Mathlib-shaped'' goals;
	\item adding small, focused procedures for functional-relational reasoning (e.g.\@ determinism, domain/range inclusion, extensionality, and application lemmas);
	\item providing lemmas for common PO families and delegation to standard Mathlib automation and reasoning.
\end{itemize}
This would allow \barrel to discharge a larger fraction of proof obligations automatically, while keeping the overall architecture modular and maintainable.
In the same vein towards modularity, one could also expect that \barrel provide only a generic interface for set/relational reasoning, allowing users to plug in their own implementations or strategies as needed.

\subsection{Towards a fully verified backend}
\label{sec:verified-backend}

\barrel is designed as a proof-producing backend for the goals it emits, yet it currently still relies on Atelier~B's \texttt{bxml} and \texttt{pog} binaries for B parsing and proof-obligation generation.
A natural next step is to implement a PO generator \emph{in Lean} for the supported fragment, producing Lean propositions directly over \barrel's embedding---including proper WD handling---and to establish soundness guarantees stating that discharging these generated obligations entails invariant preservation and refinement correctness.
First, this would eliminate the main external component of the trusted computing base, thereby yielding a more self-contained verification chain.
Secondly, this paves the way to developing an embedded DSL for writing B developments directly in Lean.
By reasoning on Lean terms directly, WD conditions can be directly inlined---and even automatically deduced---in the B developments.

In the same direction, one could lean toward soundness of the translation connecting B obligations to their Lean counterparts.
While the current translation is intentionally syntax-directed and close to a one-to-one mapping into our embedding, making this correspondence explicit would further reduce the amount of trusted code in the backend, although this would require a significant formalization effort---including giving formal semantics to a fragment of Lean.
